apiVersion: v1
kind: Pod
metadata:
  name: kafka-consumer-test
  labels:
    app: kafka-consumer-test
spec:
  containers:
    - name: kafka-consumer
      image: confluentinc/cp-kafka:7.5.0
      command: 
        - /bin/bash
        - -c
        - |
          echo "Waiting for Kafka to be ready..."
          sleep 10
          echo "Ensuring topic polymarket-messages exists"
          kafka-topics --bootstrap-server kafka-service:9092 \
            --topic polymarket-messages \
            --create \
            --if-not-exists \
            --partitions 1 \
            --replication-factor 1 >/tmp/topic-create.log 2>&1 || true
          cat /tmp/topic-create.log
          echo "Starting consumer for topic: polymarket-messages"
          kafka-console-consumer --bootstrap-server kafka-service:9092 \
            --topic polymarket-messages \
            --from-beginning \
            --consumer-property security.protocol=PLAINTEXT \
            --consumer-property listener.name=EXTERNAL \
            --property print.key=true \
            --property print.timestamp=true
      env:
        - name: KAFKA_BOOTSTRAP_SERVERS
          value: "kafka-service:9092"
  restartPolicy: Always
